<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offshore Wind Farm - Manila Bay Operations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #0f172a; color: #e2e8f0; user-select: none; }
        
        /* UI Overlay Container */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 420px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px);
            border-right: 1px solid #334155;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* Scrollbar */
        #ui-container::-webkit-scrollbar { width: 6px; }
        #ui-container::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        #ui-container::-webkit-scrollbar-track { background: #0f172a; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 20px;
            border-bottom: 1px solid #334155;
            text-align: center;
        }
        h1 { font-size: 20px; margin: 0; color: #38bdf8; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; text-shadow: 0 0 10px rgba(56, 189, 248, 0.3); }
        
        .dev-label {
            font-size: 11px; color: #94a3b8; margin-top: 5px;
        }
        .dev-label strong { color: #cbd5e1; }

        /* Sections */
        .section { padding: 15px; border-bottom: 1px solid #1e293b; }
        .section-title { 
            font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 700; display: flex; align-items: center; gap: 8px;
        }
        .section-title i { color: #38bdf8; }

        /* Metric Cards */
        .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .metric-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            border-left: 3px solid #3b82f6;
            transition: transform 0.2s;
        }
        .metric-card:hover { background: #263345; }
        
        /* Specific Card Colors */
        .card-energy { border-left-color: #3b82f6; } /* Blue */
        .card-grid { border-left-color: #a855f7; } /* Purple */
        .card-money { border-left-color: #10b981; } /* Green */
        .card-bess { border-left-color: #f59e0b; } /* Orange */
        .card-warn { border-left-color: #ef4444; } /* Red */

        .metric-label { font-size: 10px; color: #94a3b8; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .metric-value { font-size: 18px; font-weight: 700; color: #f1f5f9; font-family: 'Courier New', monospace; }
        .metric-unit { font-size: 10px; color: #64748b; margin-left: 2px; }

        /* BESS Detail Panel */
        .bess-panel {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 5px;
        }
        .bess-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 11px; }
        .bess-val { font-family: monospace; font-weight: bold; color: #fbbf24; }

        /* Controls */
        .control-group { margin-bottom: 12px; }
        .control-label { display: flex; justify-content: space-between; font-size: 11px; color: #cbd5e1; margin-bottom: 6px; }
        
        input[type="range"] {
            width: 100%; height: 6px; background: #334155; border-radius: 3px; outline: none; -webkit-appearance: none; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px; background: #38bdf8; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }

        /* Buttons */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        button {
            background: #334155; color: #e2e8f0; border: none; padding: 10px; border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 11px; width: 100%; text-transform: uppercase; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        button:hover { background: #475569; color: #fff; }
        button.active { background: #38bdf8; color: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        
        button.btn-danger { background: #7f1d1d; color: #fca5a5; border: 1px solid #ef4444; margin-top: 10px; }
        button.btn-danger:hover { background: #991b1b; color: #fff; }
        
        button.btn-warn { background: #713f12; color: #fcd34d; border: 1px solid #f59e0b; }
        button.btn-warn:hover { background: #854d0e; }

        /* Graph & Log */
        canvas { width: 100%; height: 80px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; }
        
        #scada-console {
            background-color: #020617;
            border: 1px solid #334155;
            border-left: 3px solid #10b981;
            border-radius: 6px;
            height: 120px;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: #94a3b8;
            margin-top: 5px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-time { color: #64748b; margin-right: 8px; }
        .log-info { color: #38bdf8; }
        .log-warn { color: #facc15; }
        .log-err { color: #f87171; font-weight: bold; }
        .log-sys { color: #10b981; }

        /* Overlay Alert */
        .alert-overlay {
            position: absolute; top: 20px; right: 20px; padding: 20px; background: rgba(220, 38, 38, 0.9); color: white; font-weight: 800; font-size: 14px;
            border-radius: 8px; display: none; z-index: 100; pointer-events: none; animation: flash 1s infinite;
            border: 2px solid white; box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); text-transform: uppercase;
        }
        @keyframes flash { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a;
            display: flex; justify-content: center; align-items: center; z-index: 999; color: #38bdf8; font-size: 24px; font-family: sans-serif;
        }
    </style>
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

    <div id="loading"><i class="fas fa-circle-notch fa-spin"></i> &nbsp; Initializing Systems...</div>
    <div id="alert-box" class="alert-overlay"><i class="fas fa-exclamation-triangle"></i> BIRD COLLISION RISK DETECTED</div>

    <div id="ui-container">
        <div class="header">
            <h1>Manila Bay Wind</h1>
            <div class="dev-label">
                Developed by <strong>Engr. Franz Xyrlo I. Tobias, PEE</strong>
            </div>
        </div>
        
        <!-- TELEMETRY -->
        <div class="section">
            <div class="section-title"><i class="fas fa-bolt"></i> Generation Telemetry</div>
            <div class="metric-grid">
                <div class="metric-card card-energy">
                    <span class="metric-label">Active Power <i class="fas fa-plug"></i></span>
                    <span class="metric-value" id="val-power">0.0 <span class="metric-unit">MW</span></span>
                </div>
                <div class="metric-card card-energy">
                    <span class="metric-label">Reactive Power <i class="fas fa-wave-square"></i></span>
                    <span class="metric-value" id="val-mvar">0.0 <span class="metric-unit">MVAR</span></span>
                </div>
                <div class="metric-card card-grid" id="box-freq">
                    <span class="metric-label">Grid Freq <i class="fas fa-heartbeat"></i></span>
                    <span class="metric-value" id="val-freq">60.00 <span class="metric-unit">Hz</span></span>
                </div>
                <div class="metric-card card-money">
                    <span class="metric-label">Spot Price <i class="fas fa-tag"></i></span>
                    <span class="metric-value">₱<span id="val-price">12.00</span> <span class="metric-unit">/kWh</span></span>
                </div>
                <div class="metric-card card-money">
                    <span class="metric-label">Revenue <i class="fas fa-coins"></i></span>
                    <span class="metric-value">₱<span id="val-revenue">0</span> <span class="metric-unit">/hr</span></span>
                </div>
                <div class="metric-card card-energy">
                    <span class="metric-label">Capacity Factor <i class="fas fa-tachometer-alt"></i></span>
                    <span class="metric-value" id="val-cap">0 <span class="metric-unit">%</span></span>
                </div>
            </div>
        </div>

        <!-- BESS TECHNICAL -->
        <div class="section">
            <div class="section-title"><i class="fas fa-battery-full"></i> BESS Status (Li-Ion)</div>
            <div class="metric-grid">
                <div class="metric-card card-bess">
                    <span class="metric-label">State of Charge</span>
                    <span class="metric-value" id="val-soc">50.0 <span class="metric-unit">%</span></span>
                </div>
                <div class="metric-card card-bess">
                    <span class="metric-label">Power Flow</span>
                    <span class="metric-value" id="val-bess-flow">0.0 <span class="metric-unit">MW</span></span>
                </div>
            </div>
            <div class="bess-panel">
                <div class="bess-row"><span>Status:</span> <span class="bess-val" id="bess-status">STANDBY</span></div>
                <div class="bess-row"><span>Cell Temp:</span> <span class="bess-val" id="bess-temp">25.0 °C</span></div>
                <div class="bess-row"><span>Cycle Count:</span> <span class="bess-val" id="bess-cycles">142</span></div>
                <div class="bess-row"><span>State of Health:</span> <span class="bess-val">98.5%</span></div>
            </div>
            <div class="control-group" style="margin-top: 8px;">
                <button id="btn-bess" onclick="toggleBESS()"><i class="fas fa-random"></i> Mode: AUTO</button>
            </div>
        </div>
        
        <!-- SCADA -->
        <div class="section">
            <div class="section-title"><i class="fas fa-terminal"></i> SCADA Event Log</div>
            <div id="scada-console">
                <div class="log-entry"><span class="log-time">00:00:00</span> <span class="log-sys">SYSTEM INITIALIZED</span></div>
                <div class="log-entry"><span class="log-time">00:00:01</span> <span class="log-info">CONNECTED TO NGCP GRID</span></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="section">
            <div class="section-title"><i class="fas fa-sliders-h"></i> Environmental Controls</div>
            
            <div class="control-group">
                <div class="control-label"><span><i class="far fa-clock"></i> Time of Day</span> <span id="disp-time">12:00</span></div>
                <input type="range" id="in-time" min="0" max="24" step="0.1" value="12">
            </div>
            
            <div class="control-group">
                <div class="control-label"><span><i class="fas fa-wind"></i> Wind Speed</span> <span id="disp-wind">12 m/s</span></div>
                <input type="range" id="in-wind" min="0" max="30" step="0.5" value="12">
            </div>

            <div class="control-group">
                <div class="control-label"><span><i class="fas fa-industry"></i> Grid Demand</span> <span id="disp-demand">70 MW</span></div>
                <input type="range" id="in-demand" min="0" max="150" step="1" value="70">
            </div>

            <div class="btn-grid">
                <button id="btn-storm" onclick="toggleStorm()"><i class="fas fa-cloud-showers-heavy"></i> Storm</button>
                <button id="btn-radar" onclick="toggleRadar()"><i class="fas fa-broadcast-tower"></i> Radar</button>
                <button id="btn-audio" onclick="toggleAudio()"><i class="fas fa-volume-up"></i> Audio</button>
            </div>
            
            <div class="control-group">
                <div class="control-label" style="color:#f87171">Active Faults: <span id="disp-faults">0</span></div>
                <button class="btn-warn" id="btn-repair" onclick="dispatchCTV()"><i class="fas fa-tools"></i> Dispatch CTV</button>
            </div>
        </div>

        <!-- CAMERAS -->
        <div class="section">
            <div class="section-title"><i class="fas fa-video"></i> Camera Feeds</div>
            <div class="btn-grid">
                <button onclick="setCam('drone')"><i class="fas fa-drone"></i> Drone</button>
                <button onclick="setCam('farm')"><i class="fas fa-th"></i> Farm</button>
                <button onclick="setCam('ship')"><i class="fas fa-ship"></i> Ship</button>
                <button onclick="setCam('top')"><i class="fas fa-map"></i> Map</button>
            </div>
            <div class="section-title" style="margin-top:10px;">Power Curve</div>
            <canvas id="power-graph" width="340" height="80"></canvas>
        </div>

        <div class="section" style="border:none;">
            <button class="btn-danger" id="btn-brake" onclick="toggleBrake()"><i class="fas fa-power-off"></i> EMERGENCY SHUTDOWN</button>
        </div>
        
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            bladeLength: 65,
            towerHeight: 90,
            waterColor: 0x004466,
            skyColorDay: new THREE.Color(0x87CEEB),
            skyColorNight: new THREE.Color(0x050510),
            skyColorStorm: new THREE.Color(0x222225),
            ratedPower: 8.0, // MW per turbine
            numTurbines: 10,
            cutIn: 3.0,
            cutOut: 25.0,
            bessCapacity: 50, // MWh
            bessRate: 10 // MW
        };

        // --- STATE MANAGEMENT ---
        const state = {
            windSpeed: 12,
            windDir: 0, 
            waveHeight: 2.5,
            currentSpeed: 0.5,
            currentDir: 90,
            yaw: 0, pitch: 0, rpm: 0,
            autoYaw: true, brake: false,
            time: 12, simTime: 0,
            
            // Features
            audioEnabled: false,
            radarEnabled: false,
            birdRisk: false,
            droneMode: false,
            stormMode: false,
            
            // Grid & BESS
            gridDemand: 70, // MW
            gridFreq: 60.00,
            bessSoC: 50, // %
            bessMode: 'AUTO', // AUTO, CHARGE, DISCHARGE
            bessFlow: 0, // MW (+ is discharging, - is charging)
            bessTemp: 25.0,
            bessCycles: 142,
            
            // Economics
            spotPrice: 12.00, 
            spotTarget: 12.00,
            
            // Objects
            turbines: [], 
            maintenanceTarget: null, 
            ctvPosition: new THREE.Vector3(20, 0, 20),
            rainSystem: null,
            flashTimer: 0
        };

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(CONFIG.skyColorDay, 0.0003);
        scene.background = CONFIG.skyColorDay.clone();

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 8000);
        camera.position.set(0, 300, 1000); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 2 - 0.02;
        controls.minDistance = 10;
        controls.maxDistance = 3500;

        // --- AUDIO ENGINE ---
        let audioCtx;
        let windNode, oceanNode, humNode;
        
        function initAudio() {
            if(state.audioEnabled) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            // White Noise (Wind)
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
            const d = buf.getChannelData(0); for(let i=0; i<d.length; i++) d[i]=Math.random()*2-1;
            const n = audioCtx.createBufferSource(); n.buffer = buf; n.loop = true;
            const f = audioCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=400;
            windNode = audioCtx.createGain(); windNode.gain.value=0;
            n.connect(f); f.connect(windNode); windNode.connect(audioCtx.destination); n.start();

            // Hum
            const o = audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.value=50;
            const hf = audioCtx.createBiquadFilter(); hf.type='lowpass'; hf.frequency.value=200;
            humNode = audioCtx.createGain(); humNode.gain.value=0;
            o.connect(hf); hf.connect(humNode); humNode.connect(audioCtx.destination); o.start();

            state.audioEnabled = true;
            document.getElementById('btn-audio').classList.add('active');
            logEvent("AUDIO ENGINE STARTED", "sys");
        }
        function updateAudio() {
            if(!state.audioEnabled) return;
            windNode.gain.setTargetAtTime(state.windSpeed/50, audioCtx.currentTime, 0.1);
            if(state.turbines.length > 0) humNode.gain.setTargetAtTime(state.turbines[0].rpm/30, audioCtx.currentTime, 0.1);
        }
        function toggleAudio() { 
            if(!state.audioEnabled) initAudio(); 
            else { audioCtx.close(); state.audioEnabled = false; document.getElementById('btn-audio').classList.remove('active'); logEvent("AUDIO ENGINE STOPPED", "sys"); }
        }

        // --- ASSETS & MATERIALS ---
        const mat = {
            yellow: new THREE.MeshStandardMaterial({ color: 0xffcc00, roughness: 0.5 }),
            cebuYellow: new THREE.MeshStandardMaterial({ color: 0xfdb913, roughness: 0.4 }),
            white: new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.4 }),
            redLight: new THREE.MeshBasicMaterial({ color: 0xff0000 }),
            offLight: new THREE.MeshBasicMaterial({ color: 0x330000 }),
            steel: new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.6 }),
            water: new THREE.MeshStandardMaterial({ color: CONFIG.waterColor, roughness: 0.05, metalness: 0.6, flatShading: true }),
            sand: new THREE.MeshStandardMaterial({ color: 0xe6c288, roughness: 0.9 }),
            grass: new THREE.MeshStandardMaterial({ color: 0x55aa55, roughness: 0.8 }),
            grey: new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.6, roughness: 0.4 }),
            blackHull: new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.7 }),
            rain: new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.5, transparent: true, opacity: 0.6 })
        };

        // --- LIGHTING ---
        const ambientLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.4);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
        sunLight.position.set(-500, 1000, 500);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.left = -2000; sunLight.shadow.camera.right = 2000;
        sunLight.shadow.camera.top = 2000; sunLight.shadow.camera.bottom = -2000;
        scene.add(sunLight);

        // --- OCEAN ---
        const waterGeo = new THREE.PlaneGeometry(6000, 6000, 128, 128);
        const ocean = new THREE.Mesh(waterGeo, mat.water);
        ocean.rotation.x = -Math.PI / 2;
        ocean.receiveShadow = true;
        scene.add(ocean);
        const originalPositions = [];
        for (let i = 0; i < waterGeo.attributes.position.count; i++) {
            originalPositions.push({ x: waterGeo.attributes.position.getX(i), y: waterGeo.attributes.position.getY(i), z: waterGeo.attributes.position.getZ(i) });
        }

        // --- LANDMASS GENERATION ---
        function createLand() {
            const landGroup = new THREE.Group();
            // Moved land back to accommodate larger farm spacing (Z = -1500)
            landGroup.position.set(0, -5, -1500); 
            
            // Island Base
            const islandGeo = new THREE.CylinderGeometry(800, 900, 40, 64);
            islandGeo.scale(3.0, 1, 0.5); 
            const island = new THREE.Mesh(islandGeo, mat.sand);
            island.receiveShadow = true;
            landGroup.add(island);

            // Grassy Top
            const grassGeo = new THREE.CylinderGeometry(750, 800, 10, 64);
            grassGeo.scale(2.9, 1, 0.45);
            const grass = new THREE.Mesh(grassGeo, mat.grass);
            grass.position.y = 25;
            grass.receiveShadow = true;
            landGroup.add(grass);

            // BESS Facility
            const bessGroup = new THREE.Group();
            bessGroup.position.set(-300, 30, 50);
            for(let i=0; i<6; i++) {
                const container = new THREE.Mesh(new THREE.BoxGeometry(20, 10, 40), mat.white);
                container.position.set(i*30, 5, 0); container.castShadow = true;
                
                // Add detail
                const door = new THREE.Mesh(new THREE.PlaneGeometry(15, 8), mat.grey);
                door.position.set(0, 0, 20.1);
                container.add(door);
                
                bessGroup.add(container);
            }
            const fence = new THREE.Mesh(new THREE.BoxGeometry(200, 5, 1), mat.steel);
            fence.position.set(75, 2.5, 30);
            bessGroup.add(fence);
            landGroup.add(bessGroup);

            // Lighthouse
            const lhGroup = new THREE.Group();
            lhGroup.position.set(600, 30, 50);
            const base = new THREE.Mesh(new THREE.CylinderGeometry(8, 12, 40), mat.white);
            const top = new THREE.Mesh(new THREE.CylinderGeometry(9, 9, 6), mat.blackHull);
            top.position.y = 20;
            const glass = new THREE.Mesh(new THREE.CylinderGeometry(7, 7, 6), new THREE.MeshStandardMaterial({color: 0xffffaa, transparent: true, opacity: 0.6}));
            glass.position.y = 26;
            const roof = new THREE.Mesh(new THREE.ConeGeometry(9, 6, 16), new THREE.MeshStandardMaterial({color: 0xaa0000}));
            roof.position.y = 30;

            lhGroup.add(base); lhGroup.add(top); lhGroup.add(glass); lhGroup.add(roof);
            landGroup.add(lhGroup);

            // Trees
            for(let i=0; i<100; i++) {
                const tree = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(2, 3, 10), new THREE.MeshStandardMaterial({color:0x5A3A19}));
                const leaves = new THREE.Mesh(new THREE.ConeGeometry(8, 20, 8), new THREE.MeshStandardMaterial({color:0x228822}));
                leaves.position.y = 10; tree.add(trunk); tree.add(leaves);
                const xPos = (Math.random() - 0.5) * 3000;
                const zPos = (Math.random() - 0.5) * 200;
                tree.position.set(xPos, 30, zPos);
                landGroup.add(tree);
            }

            scene.add(landGroup);
        }
        createLand();

        // Rain System
        function createRain() {
            const geom = new THREE.BufferGeometry();
            const vertices = [];
            for(let i=0; i<15000; i++) {
                vertices.push(Math.random()*4000 - 2000);
                vertices.push(Math.random()*1000);
                vertices.push(Math.random()*4000 - 2000);
            }
            geom.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            state.rainSystem = new THREE.Points(geom, mat.rain);
            state.rainSystem.visible = false;
            scene.add(state.rainSystem);
        }
        createRain();

        // --- TURBINE GENERATION ---
        const bladeGeo = new THREE.Shape();
        bladeGeo.moveTo(0,0); bladeGeo.bezierCurveTo(1,0, 2.5,4, 0.5, CONFIG.bladeLength); bladeGeo.lineTo(0, CONFIG.bladeLength); bladeGeo.bezierCurveTo(-0.5,4, -1.5,0.5, 0,0);
        const bladeMeshGeo = new THREE.ExtrudeGeometry(bladeGeo, {steps: 5, depth: 0.5, bevelEnabled: true, bevelThickness:0.1, bevelSize:0.05});
        bladeMeshGeo.translate(0,0,-0.25); bladeMeshGeo.computeVertexNormals();

        const towerGeo = new THREE.CylinderGeometry(3, 4.5, CONFIG.towerHeight, 16);
        const nacelleGeo = new THREE.BoxGeometry(10, 6, 16);
        const hubGeo = new THREE.SphereGeometry(3.5, 16, 16);

        function createTurbine(x, z, id) {
            const root = new THREE.Group();
            root.position.set(x, 0, z);
            scene.add(root);

            const pile = new THREE.Mesh(new THREE.CylinderGeometry(4.5, 4.5, 30, 16), mat.yellow);
            pile.position.y = 10; pile.castShadow = true; pile.receiveShadow = true;
            root.add(pile);

            const towerMat = mat.white.clone();
            const tower = new THREE.Mesh(towerGeo, towerMat);
            tower.position.y = 15 + CONFIG.towerHeight/2; 
            tower.castShadow = true;
            root.add(tower);

            const nacelleGroup = new THREE.Group();
            nacelleGroup.position.y = 15 + CONFIG.towerHeight;
            root.add(nacelleGroup);

            const nacelle = new THREE.Mesh(nacelleGeo, mat.white);
            nacelle.position.z = 4; nacelle.castShadow = true;
            nacelleGroup.add(nacelle);

            const avLight = new THREE.Mesh(new THREE.SphereGeometry(0.6), mat.offLight.clone());
            avLight.position.set(0, 4, 0);
            nacelleGroup.add(avLight);
            const pointLight = new THREE.PointLight(0xff0000, 0, 100);
            pointLight.position.set(0, 5, 0);
            nacelleGroup.add(pointLight);

            const hubGroup = new THREE.Group();
            hubGroup.position.z = -5;
            hubGroup.rotation.z = Math.random() * Math.PI * 2; 
            nacelleGroup.add(hubGroup);
            
            const hub = new THREE.Mesh(hubGeo, mat.white);
            hub.scale.z = 1.3; hubGroup.add(hub);

            const blades = [];
            for(let i=0; i<3; i++){
                const bGrp = new THREE.Group();
                bGrp.rotation.z = i * 120 * (Math.PI/180);
                const b = new THREE.Mesh(bladeMeshGeo, mat.white);
                b.castShadow = true;
                bGrp.add(b);
                hubGroup.add(bGrp);
                blades.push(bGrp);
            }

            state.turbines.push({
                id: id,
                root: root,
                tower: tower,
                nacelle: nacelleGroup,
                hub: hubGroup,
                blades: blades,
                avLightMat: avLight.material,
                pointLight: pointLight,
                localWindSpeed: 0,
                power: 0,
                rpm: 0,
                stress: 0,
                health: 100,
                row: z > -400 ? 1 : 0
            });
        }

        for(let r=0; r<2; r++) {
            for(let c=0; c<5; c++) {
                createTurbine(-600 + c*300, -600 + r*400, r*5+c);
            }
        }

        // --- SHIPS & TRAFFIC ---
        const ships = [];
        function createGenericShip(type, color, x, z, speed, scale=1) {
            const group = new THREE.Group();
            group.position.set(x, 0, z);
            let hull;
            if (type === 'cargo') {
                hull = new THREE.Mesh(new THREE.BoxGeometry(15, 8, 80), new THREE.MeshStandardMaterial({color: color}));
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(14, 12, 10), mat.white);
                bridge.position.set(0, 10, 30); hull.add(bridge);
                hull.rotation.y = Math.PI/2; 
            } else if (type === 'fishing') {
                hull = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 16), new THREE.MeshStandardMaterial({color: color}));
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(5, 5, 6), mat.white);
                cabin.position.set(0, 4, 2); hull.add(cabin);
                const mast = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,12), mat.grey);
                mast.position.set(0, 6, -3); hull.add(mast);
                hull.rotation.y = Math.PI/2;
            } else if (type === 'yacht') {
                hull = new THREE.Mesh(new THREE.ConeGeometry(5, 20, 4), mat.white);
                hull.rotation.set(-Math.PI/2, 0, -Math.PI/2); hull.scale.set(1, 0.5, 1);
                const cabin = new THREE.Mesh(new THREE.BoxGeometry(4, 3, 6), new THREE.MeshStandardMaterial({color:0xeeeeee}));
                cabin.position.set(0, 2, 0); 
                const wrapper = new THREE.Group(); wrapper.add(hull); wrapper.add(cabin); wrapper.rotation.y = Math.PI/2; hull = wrapper;
            } else if (type === 'tanker') {
                hull = new THREE.Mesh(new THREE.BoxGeometry(18, 7, 90), mat.blackHull);
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(16, 10, 12), mat.white);
                bridge.position.set(0, 9, -35); hull.add(bridge);
                hull.rotation.y = Math.PI/2;
            }
            hull.position.y = 2; hull.scale.set(scale, scale, scale); group.add(hull); scene.add(group);
            ships.push({group: group, speed: speed, limit: 2500});
        }
        createGenericShip('cargo', 0x228822, -600, 200, 6); createGenericShip('cargo', 0x3333aa, -900, 300, 5);
        createGenericShip('cargo', 0xaa5522, -1200, 600, 7); createGenericShip('fishing', 0xcc4444, 200, 400, 8, 1.2); 
        createGenericShip('fishing', 0x44cc44, -200, 500, 7, 1.2); createGenericShip('yacht', 0xffffff, -500, 100, 12, 1.5); 
        createGenericShip('tanker', 0x000000, 1000, 800, -4); 

        // CTV
        const ctvGroup = new THREE.Group(); ctvGroup.position.set(200, 0, 200); scene.add(ctvGroup);
        const ctvMesh = new THREE.Mesh(new THREE.BoxGeometry(8, 4, 20), new THREE.MeshStandardMaterial({color: 0xff8800}));
        ctvMesh.position.y = 2; ctvGroup.add(ctvMesh);
        const ctvCabin = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 8), mat.white); ctvCabin.position.set(0, 5, 2); ctvGroup.add(ctvCabin);

        // Planes
        const planes = [];
        function addPlane(x, y, z, speed) {
            const g = new THREE.Group(); g.position.set(x,y,z);
            const f = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 18, 16), mat.white); f.rotation.z = -Math.PI / 2; g.add(f);
            const n = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), mat.cebuYellow); n.position.x = 9; g.add(n);
            const w = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 16), mat.cebuYellow); w.position.set(2, 0, 0); g.add(w);
            const t = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 0.2), mat.cebuYellow); t.position.set(-10, 2.5, 0); g.add(t);
            g.userData = { speed: speed }; scene.add(g); planes.push(g);
        }
        addPlane(-800, 200, 0, 80); addPlane(-1000, 250, 150, 90);

        // --- SCADA LOGIC ---
        function logEvent(msg, type='info') {
            const console = document.getElementById('scada-console');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            entry.innerHTML = `<span class="log-time">${time}</span> <span class="log-${type}">${msg}</span>`;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        // --- PHYSICS & LOGIC ---
        function calculateWake() {
            const windRad = state.windDir * (Math.PI/180);
            state.turbines.forEach(t => {
                let wakeFactor = 1.0;
                if (Math.cos(windRad) > 0.8 && t.row === 1) wakeFactor = 0.7; 
                else if (Math.cos(windRad) < -0.8 && t.row === 0) wakeFactor = 0.7;
                t.localWindSpeed = state.windSpeed * wakeFactor;
                if (state.birdRisk && state.radarEnabled) t.localWindSpeed = 0;
                if (state.stormMode && state.windSpeed > 25) t.localWindSpeed = 0;
            });
        }

        function calculateGridPhysics() {
            let totalPower = 0;
            state.turbines.forEach(t => totalPower += t.power);

            // BESS Logic
            if(state.bessMode === 'AUTO') {
                if(state.spotPrice < 11.5 && state.bessSoC < 100) state.bessFlow = -CONFIG.bessRate; // Charge
                else if((state.spotPrice > 12.5 || state.gridFreq < 59.9) && state.bessSoC > 0) state.bessFlow = CONFIG.bessRate; // Discharge
                else state.bessFlow = 0;
            }

            // SoC Update (simplified dt factor)
            if(state.bessFlow !== 0) {
                const dE = (state.bessFlow / 3600) * 0.1; // Fast sim rate
                state.bessSoC -= (dE / CONFIG.bessCapacity) * 100;
                state.bessSoC = Math.max(0, Math.min(100, state.bessSoC));
                
                // Temp sim
                if(state.bessFlow < 0) state.bessTemp += 0.05; // Charging heats up
                else state.bessTemp += 0.03; // Discharging heats up
            } else {
                state.bessTemp = Math.max(25, state.bessTemp - 0.05); // Cool down
            }

            // Frequency
            const netGen = totalPower + state.bessFlow;
            const deltaP = netGen - state.gridDemand;
            state.gridFreq = 60.0 + (deltaP * 0.05);
            state.gridFreq = Math.max(58, Math.min(62, state.gridFreq));

            // Alerts
            if(state.gridFreq < 59.5 && Math.random() < 0.02) logEvent(`GRID FREQ LOW: ${state.gridFreq.toFixed(2)}Hz`, 'warn');
            if(state.bessSoC < 10 && state.bessFlow > 0 && Math.random() < 0.02) logEvent("BESS LOW SOC", 'warn');

            // UI
            document.getElementById('val-power').innerText = totalPower.toFixed(1);
            document.getElementById('val-mvar').innerText = (totalPower * 0.3).toFixed(1);
            document.getElementById('val-freq').innerText = state.gridFreq.toFixed(2);
            document.getElementById('val-soc').innerText = state.bessSoC.toFixed(1);
            document.getElementById('val-bess-flow').innerText = state.bessFlow.toFixed(1);
            document.getElementById('val-cap').innerText = ((totalPower / (CONFIG.numTurbines * CONFIG.ratedPower))*100).toFixed(0);
            
            // BESS Panel Update
            document.getElementById('bess-status').innerText = state.bessFlow > 0 ? "DISCHARGING" : (state.bessFlow < 0 ? "CHARGING" : "STANDBY");
            document.getElementById('bess-temp').innerText = state.bessTemp.toFixed(1) + " °C";
            document.getElementById('bess-cycles').innerText = state.bessCycles;

            // Revenue
            const revenueRate = netGen * 1000 * state.spotPrice;
            document.getElementById('val-revenue').innerText = Math.floor(revenueRate).toLocaleString();
        }

        // --- GRAPHING ---
        const cvs = document.getElementById('power-graph');
        const ctx = cvs.getContext('2d');
        function drawGraph() {
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,340,80);
            ctx.strokeStyle = '#334155'; ctx.lineWidth=1;
            ctx.beginPath();
            for(let i=0; i<340; i+=34) { ctx.moveTo(i,0); ctx.lineTo(i,80); }
            ctx.stroke();

            ctx.strokeStyle = '#38bdf8'; ctx.lineWidth=2;
            ctx.beginPath();
            for(let v=0; v<=30; v++) {
                const x = (v/30) * 340;
                let p = 0;
                if(v >= 3 && v <= 25) {
                    p = Math.min(Math.pow(v/12, 3), 1.0);
                }
                const y = 80 - (p * 70);
                if(v==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();

            const avgWind = state.windSpeed;
            let totalP = 0;
            state.turbines.forEach(t => totalP += t.power);
            let avgPowerPct = (totalP / (CONFIG.numTurbines * CONFIG.ratedPower));

            const dotX = (avgWind / 30) * 340;
            const dotY = 80 - (avgPowerPct * 70);
            
            ctx.fillStyle = '#facc15';
            ctx.beginPath(); ctx.arc(dotX, dotY, 4, 0, Math.PI*2); ctx.fill();
        }

        // --- MAIN LOOP ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            state.simTime += dt;
            TWEEN.update();

            // Economics
            state.spotPrice = THREE.MathUtils.lerp(state.spotPrice, state.spotTarget, 0.05);
            document.getElementById('val-price').innerText = state.spotPrice.toFixed(2);

            // Env
            const isNight = state.time < 6 || state.time > 18;
            const targetColor = state.stormMode ? CONFIG.skyColorStorm : (isNight ? CONFIG.skyColorNight : CONFIG.skyColorDay);
            scene.background.lerp(targetColor, 0.05);
            scene.fog.color.lerp(targetColor, 0.05);
            
            const sunAngle = (state.time - 6) * (Math.PI / 12);
            sunLight.position.set(Math.cos(sunAngle) * 1000, Math.sin(sunAngle) * 1000, 500);
            sunLight.intensity = state.stormMode ? 0.2 : (isNight ? 0.1 : 1.2);

            // Storm/Lightning
            if(state.stormMode) {
                if(Math.random() < 0.005) {
                    scene.background = new THREE.Color(0xffffff);
                    setTimeout(()=>scene.background=targetColor, 50);
                    logEvent("LIGHTNING STRIKE DETECTED", 'err');
                }
                const pos = state.rainSystem.geometry.attributes.position.array;
                for(let i=1; i<pos.length; i+=3) {
                    pos[i] -= 20; if(pos[i] < 0) pos[i] = 1000;
                }
                state.rainSystem.geometry.attributes.position.needsUpdate = true;
            }

            if (state.radarEnabled && Math.random() < 0.002) {
                state.birdRisk = true;
                document.getElementById('alert-box').style.display = 'block';
                logEvent("AVIAN RADAR: FLOCK DETECTED", 'warn');
                setTimeout(() => { state.birdRisk = false; document.getElementById('alert-box').style.display = 'none'; }, 3000);
            }

            calculateWake();
            
            // Turbine Physics
            state.turbines.forEach(t => {
                t.avLightMat.color.setHex(isNight || state.stormMode ? 0xff0000 : 0x330000);
                t.pointLight.intensity = isNight || state.stormMode ? 1 : 0;

                // Visual Stress
                const s = (t.localWindSpeed/30)*50 + (state.waveHeight/10)*30;
                t.tower.material.color.setHSL((1.0 - Math.min(s/100, 1))*0.3, 1.0, 0.5);
                if(t.health<=0) { t.tower.material.color.setHex(0x000000); t.localWindSpeed=0; }

                let targetRPM = 0;
                if (!state.brake && t.health > 0 && t.localWindSpeed >= CONFIG.cutIn && t.localWindSpeed <= CONFIG.cutOut) {
                    targetRPM = (t.localWindSpeed * 7 * 60) / (2 * Math.PI * CONFIG.bladeLength);
                    if(targetRPM > 14) targetRPM = 14;
                }
                t.rpm = THREE.MathUtils.lerp(t.rpm, targetRPM, 0.2 * dt);
                t.hub.rotation.z -= (t.rpm * 2 * Math.PI / 60) * dt;
                
                if(t.rpm > 1) {
                    t.power = Math.pow(t.localWindSpeed/12, 3) * CONFIG.ratedPower;
                    if(t.power > CONFIG.ratedPower) t.power = CONFIG.ratedPower;
                } else t.power = 0;

                if(state.autoYaw && t.health > 0) {
                    const windRad = state.windDir * (Math.PI/180);
                    let diff = windRad - t.nacelle.rotation.y;
                    if(diff > Math.PI) diff -= Math.PI*2; if(diff < -Math.PI) diff += Math.PI*2;
                    t.nacelle.rotation.y += Math.sign(diff) * Math.min(Math.abs(diff), 0.5*dt);
                }
            });

            calculateGridPhysics();
            drawGraph();
            updateAudio();

            // Movement
            ships.forEach(s => {
                s.group.position.x += s.speed * dt;
                if(s.group.position.x > s.limit) s.group.position.x = -s.limit;
                if(s.group.position.x < -s.limit) s.group.position.x = s.limit;
            });
            planes.forEach(p => {
                p.position.x += p.userData.speed * dt;
                if(p.position.x > 2500) p.position.x = -2500;
            });

            const pos = waterGeo.attributes.position;
            for(let i=0; i<pos.count; i++) {
                const orig = originalPositions[i];
                const z = Math.sin(orig.x*0.01 + state.simTime)*state.waveHeight*0.4 + Math.cos(orig.y*0.01 + state.simTime)*state.waveHeight*0.4;
                pos.setZ(i, z);
            }
            pos.needsUpdate = true; waterGeo.computeVertexNormals();

            if(state.droneMode) {
                const t = state.turbines[0];
                const a = state.simTime * 0.5;
                camera.position.set(t.root.position.x + Math.cos(a)*80, 90 + Math.sin(state.simTime)*20, t.root.position.z + Math.sin(a)*80);
                camera.lookAt(t.root.position.x, 90, t.root.position.z);
            }

            renderer.render(scene, camera);
        }

        // --- CONTROLS ---
        function toggleRadar() { 
            state.radarEnabled = !state.radarEnabled; 
            document.getElementById('btn-radar').classList.toggle('active');
            logEvent(`RADAR ${state.radarEnabled?'ENABLED':'DISABLED'}`, 'sys');
        }
        function toggleStorm() {
            state.stormMode = !state.stormMode;
            document.getElementById('btn-storm').classList.toggle('active');
            state.rainSystem.visible = state.stormMode;
            logEvent(state.stormMode ? "STORM PROTOCOL INITIATED" : "WEATHER CLEARING", state.stormMode ? 'warn' : 'info');
        }
        function toggleBESS() {
            const modes = ['AUTO', 'CHARGE', 'DISCHARGE'];
            let idx = modes.indexOf(state.bessMode);
            state.bessMode = modes[(idx+1)%3];
            document.getElementById('btn-bess').innerHTML = `<i class="fas fa-random"></i> Mode: ${state.bessMode}`;
            if(state.bessMode !== 'AUTO') state.bessFlow = state.bessMode === 'CHARGE' ? -CONFIG.bessRate : CONFIG.bessRate;
            logEvent(`BESS MODE: ${state.bessMode}`, 'sys');
        }
        function setCam(mode) {
            state.droneMode = (mode === 'drone');
            if(mode === 'farm') { camera.position.set(0, 300, 1000); controls.target.set(0,0,0); }
            else if (mode === 'ship') { camera.position.set(200, 50, 250); controls.target.set(0, 50, -300); }
            else if (mode === 'top') { camera.position.set(0, 1500, 0); controls.target.set(0,0,0); }
        }
        function toggleBrake() { 
            state.brake = !state.brake; 
            if(state.brake) logEvent("EMERGENCY STOP TRIGGERED", 'err');
            else logEvent("SYSTEM RESET - RESUMING OPS", 'sys');
        }
        function dispatchCTV() {
            if (state.maintenanceTarget !== null) {
                const t = state.turbines[state.maintenanceTarget];
                logEvent(`CTV DISPATCHED TO T${t.id}`, 'info');
                new TWEEN.Tween(ctvGroup.position).to({x: t.root.position.x+20, z: t.root.position.z+20}, 3000)
                    .easing(TWEEN.Easing.Quadratic.Out)
                    .onComplete(() => { 
                        t.health = 100; state.maintenanceTarget = null; 
                        document.getElementById('disp-faults').innerText = "0"; 
                        logEvent(`TURBINE ${t.id} REPAIRED - ONLINE`, 'sys');
                    })
                    .start();
            }
        }

        const TWEEN = { tweens: [], add: function(t){this.tweens.push(t)}, update: function(){ if(this.tweens.length>0){this.tweens.forEach(t=>t.update()); this.tweens = this.tweens.filter(t=>!t.complete);} } };
        TWEEN.Tween = function(obj){ this.obj=obj; this.complete=false; };
        TWEEN.Tween.prototype = { 
            to: function(props, dur){ this.end=props; this.dur=dur; return this; }, 
            easing: function(){ return this; }, 
            onComplete: function(fn){ this.cb=fn; return this; },
            start: function(){ this.startT=Date.now(); this.startVals={...this.obj}; TWEEN.add(this); return this; },
            update: function(){ 
                let p = (Date.now()-this.startT)/this.dur; 
                if(p>=1){ p=1; this.complete=true; if(this.cb)this.cb(); }
                for(let k in this.end) this.obj[k] = this.startVals[k] + (this.end[k]-this.startVals[k])*p;
            }
        };
        TWEEN.Easing = { Quadratic: { Out: null } };

        setInterval(() => { state.spotTarget = 12.00 + (Math.random()-0.5); }, 3000);
        setInterval(() => { if (!state.maintenanceTarget && Math.random() < 0.05) {
            const id = Math.floor(Math.random() * 10);
            state.turbines[id].health = 0; state.maintenanceTarget = id;
            document.getElementById('disp-faults').innerText = `1 (T${id})`;
            logEvent(`CRITICAL FAULT: TURBINE ${id}`, 'err');
        }}, 5000);

        document.getElementById('in-time').addEventListener('input', e => { state.time = parseFloat(e.target.value); document.getElementById('disp-time').innerText = Math.floor(state.time)+":00"; });
        document.getElementById('in-wind').addEventListener('input', e => { state.windSpeed = parseFloat(e.target.value); document.getElementById('disp-wind').innerText = state.windSpeed + " m/s"; });
        document.getElementById('in-demand').addEventListener('input', e => { state.gridDemand = parseFloat(e.target.value); document.getElementById('disp-demand').innerText = state.gridDemand + " MW"; });

        window.addEventListener('resize', () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
        document.getElementById('loading').style.display = 'none';
        animate();

    </script>
</body>
</html>
